<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Panel de Revisor ‚Äì Campo Cl√≠nico UNAB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --sidebar-bg-top:#022a66;
      --sidebar-bg-bottom:#011537;
      --sidebar-border:#001229;
      --sidebar-text:#e5efff;
      --sidebar-muted:#9fb4dd;
      --sidebar-active:#ffd000;

      --bg-page:#f4f7fc;
      --card-bg:#ffffff;
      --card-border:#dde3f0;
      --card-shadow:0 14px 32px rgba(15,23,42,.12);

      --text-main:#0f172a;
      --text-muted:#6b7280;

      --accent:#0b3a7e;
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0;
      padding:0;
      height:100%;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
      display:flex;
    }

    .app-shell{
      display:flex;
      width:100%;
      min-height:100vh;
    }

    /* =========== SIDEBAR =========== */

    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--sidebar-bg-top),var(--sidebar-bg-bottom));
      border-right:1px solid var(--sidebar-border);
      color:var(--sidebar-text);
      padding:18px 18px 20px;
      display:flex;
      flex-direction:column;
    }

    .brand-title{
      font-size:0.78rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--sidebar-muted);
      margin-bottom:2px;
    }

    .brand-main{
      font-weight:600;
      font-size:0.98rem;
    }

    .user-box{
      margin-top:14px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.16);
      border:1px solid rgba(15,23,42,.55);
    }

    .user-avatar{
      width:40px;
      height:40px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:#0e4aa6;
      color:#fff;
      flex-shrink:0;
      font-size:0.9rem;
    }

    .user-info{ min-width:0; }

    .user-info strong{
      display:block;
      font-size:0.86rem;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .user-info small{
      display:block;
      font-size:0.76rem;
      color:var(--sidebar-muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .nav-label{
      margin:16px 4px 6px;
      font-size:0.72rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--sidebar-muted);
    }

    .nav-list{
      list-style:none;
      margin:0;
      padding:4px;
    }

    .nav-link{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--sidebar-text);
      text-decoration:none;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid transparent;
      cursor:pointer;
      font-size:0.86rem;
      transition:background .15s ease, border-color .15s ease, transform .08s ease;
    }

    .nav-link span.icon{
      width:20px;
      height:20px;
      border-radius:999px;
      border:1px solid rgba(203,213,225,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.78rem;
    }

    .nav-link:hover{
      background:rgba(15,23,42,.6);
      transform:translateY(-1px);
    }

    .nav-link.active{
      background:var(--sidebar-active);
      border-color:rgba(255,255,255,.25);
      color:#111827;
    }

    .sidebar-footer{
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid rgba(15,23,42,.7);
    }

    .logout-btn{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,.9);
      background:#0f172a;
      color:#f9fafb;
      cursor:pointer;
      font-size:0.85rem;
      transition:background .15s ease, box-shadow .15s ease, transform .08s ease;
    }

    .logout-btn:hover{
      background:#111827;
      box-shadow:0 12px 22px rgba(15,23,42,.6);
      transform:translateY(-1px);
    }

    /* =========== MAIN =========== */

    .main-wrapper{
      flex:1;
      padding:24px 26px 30px;
      min-height:100vh;
    }

    .main-content{
      max-width:1180px;
      margin:0 auto;
    }

    .page-header{
      margin-bottom:14px;
    }

    .page-header h1{
      margin:0 0 4px;
      font-size:1.4rem;
      color:var(--accent);
      font-weight:600;
    }

    .page-header p{
      margin:0;
      font-size:0.9rem;
      color:var(--text-muted);
      max-width:560px;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .tabs{
      display:inline-flex;
      background:#e5e7eb;
      padding:2px;
      border-radius:999px;
      gap:2px;
    }

    .tab{
      border:0;
      padding:6px 12px;
      border-radius:999px;
      font-size:0.8rem;
      background:transparent;
      cursor:pointer;
      color:#374151;
      transition:background .15s ease, color .15s ease, box-shadow .15s ease;
    }

    .tab.active{
      background:#2563eb;
      color:#f9fafb;
      box-shadow:0 6px 16px rgba(37,99,235,.4);
    }

    .search{
      flex:1;
      min-width:220px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:0.82rem;
      background:#f9fafb;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .search:focus{
      border-color:#2563eb;
      background:#ffffff;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }

    .card{
      background:var(--card-bg);
      border:1px solid:var(--card-border);
    }

    .table-card{
      background:var(--card-bg);
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:14px 16px 16px;
      box-shadow:var(--card-shadow);
    }

    table.table{
      width:100%;
      border-collapse:collapse;
      font-size:0.82rem;
    }

    .table th,
    .table td{
      border-bottom:1px solid #e6eaf0;
      padding:10px 12px;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }

    .table th{
      background:#fafbfe;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#6b7280;
    }

    .status{
      padding:4px 8px;
      border-radius:999px;
      font-size:0.75rem;
      border:1px solid #e6eaf0;
      background:#fff;
    }

    .s-warn{background:#fff7ed;border-color:#fed7aa;color:#b45309;}
    .s-ok{background:#ecfdf5;border-color:#bbf7d0;color:#059669;}
    .s-bad{background:#fef2f2;border-color:#fecaca;color:#b91c1c;}

    .btn{
      display:inline-block;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid #e6eaf0;
      background:#fff;
      text-decoration:none;
      color:#111827;
      cursor:pointer;
      font-size:0.8rem;
      font-family:inherit;
      transition:background .15s ease, box-shadow .15s ease, transform .08s ease;
    }

    .btn:hover{
      background:#f3f4f6;
      transform:translateY(-1px);
    }

    .btn.primary{
      background:#2563eb;
      border-color:#2563eb;
      color:#fff;
      box-shadow:0 8px 18px rgba(37,99,235,.45);
    }

    .btn.primary:hover{
      background:#1d4ed8;
      border-color:#1d4ed8;
    }

    /* =========== SOPORTE =========== */

    .section{ display:none; animation:fadeIn .16s ease-out; }
    .section.active{ display:block; }

    .support-card{
      background:var(--card-bg);
      border-radius:18px;
      border:1px solid var(--card-border);
      box-shadow:var(--card-shadow);
      padding:18px 20px 20px;
      max-width:900px;
    }

    .support-header h2{
      margin:0 0 6px;
      font-size:1.05rem;
      color:var(--accent);
    }

    .support-header p{
      margin:0 0 10px;
      font-size:0.9rem;
      color:var(--text-muted);
      max-width:560px;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:12px;
    }

    .chip{
      font-size:0.74rem;
      padding:4px 10px;
      border-radius:999px;
      background:#e5e7eb;
      color:#111827;
    }

    .support-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
      margin-top:6px;
    }

    .support-pill{
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      font-size:0.84rem;
    }

    .support-pill h3{
      margin:0 0 4px;
      font-size:0.86rem;
      color:#111827;
    }

    .support-pill p{
      margin:0;
      color:#4b5563;
      font-size:0.84rem;
    }

    /* =========== MODAL =========== */

    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }

    .modal.open{ display:flex; }

    .modal .box{
      width:520px;
      max-width:92vw;
      background:#fff;
      border-radius:12px;
      padding:16px;
      border:1px solid #e6eaf0;
    }

    .box h3{ margin:0 0 10px; }

    .box textarea{
      width:100%;
      min-height:120px;
      padding:10px;
      border-radius:10px;
      border:1px solid #e6eaf0;
      resize:vertical;
      font-family:inherit;
      font-size:0.9rem;
    }

    .box .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:12px;
    }

    /* NUEVO: estilo para el textarea de comentarios generales */
    .textarea-notes{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:0.85rem;
      resize:vertical;
      font-family:inherit;
      background:#f9fafb;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .textarea-notes:focus{
      border-color:#2563eb;
      background:#ffffff;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }

    @keyframes fadeIn{
      from{ opacity:0; transform:translateY(4px); }
      to{ opacity:1; transform:none; }
    }

    @media (max-width: 960px){
      .sidebar{
        position:static;
        width:100%;
        flex-direction:row;
        align-items:flex-start;
        padding:12px 16px;
      }
      .main-wrapper{
        padding:16px 14px 24px;
      }
    }

    @media (max-width: 640px){
      .sidebar{ flex-direction:column; }
      .row{
        flex-direction:column;
        align-items:flex-start;
      }
      .search{
        width:100%;
      }
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- =========== SIDEBAR =========== -->
  <aside class="sidebar">
    <div>
      <div class="brand-title">CAMPO CL√çNICO ¬∑ UNAB</div>
      <div class="brand-main">Panel de revisor</div>

      <div class="user-box">
        <div class="user-avatar">
          US
        </div>
        <div class="user-info">
          <strong title="{{ request.user.get_full_name|default:request.user.email }}">
            {{ request.user.get_full_name|default:request.user.email }}
          </strong>
          <small>Revisor</small>
        </div>
      </div>

      <div class="nav-label">Navegaci√≥n</div>
      <nav aria-label="principal">
        <ul class="nav-list">
          <li>
            <a href="#revision" class="nav-link active" data-target="revision">
              <span class="icon">üìã</span>
              <span>Revisi√≥n de fichas</span>
            </a>
          </li>
          <li>
            <a href="#soporte" class="nav-link" data-target="soporte">
              <span class="icon">üõü</span>
              <span>Soporte</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <div class="sidebar-footer">
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
      </form>
    </div>
  </aside>

  <!-- =========== MAIN =========== -->
  <div class="main-wrapper">
    <main class="main-content">

      <!-- SECCI√ìN: REVISI√ìN -->
      <section id="revision" class="section active">
        <header class="page-header">
          <h1>Revisi√≥n de fichas</h1>
          <p>
            Gestiona las fichas enviadas por los estudiantes: revisa datos,
            descarga la ficha en PDF y marca el estado final.
          </p>
        </header>

        <div class="row">
          <div class="tabs">
            <button class="tab active" data-filter="abiertas">Abiertas</button>
            <button class="tab" data-filter="cerradas">Cerradas</button>
            <button class="tab" data-filter="todas">Todas</button>
          </div>
          <input class="search" id="q" placeholder="Buscar por nombre o correo‚Ä¶" />
        </div>

        <!-- NUEVO: comentarios generales del revisor -->
        <section class="table-card" style="margin-bottom:12px;">
          <h2 style="margin:0 0 6px;font-size:0.98rem;">Comentarios generales de la revisi√≥n</h2>
          <p style="margin:0 0 8px;font-size:0.84rem;color:var(--text-muted);">
            Este comentario se utilizar√° como observaci√≥n global al finalizar la revisi√≥n
            de una ficha y ser√° enviado al estudiante en el correo.
          </p>
          <textarea
            id="globalNotes"
            rows="3"
            class="textarea-notes"
            placeholder="Escribe aqu√≠ los comentarios generales sobre la ficha antes de pulsar ‚ÄúFinalizar revisi√≥n‚Äù‚Ä¶"
          ></textarea>
        </section>

        <section class="table-card">
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>RUT / ID</th>
                <th>Correo</th>
                <th>Estado</th>
                <th>Actualizada</th>
                <th style="min-width:320px;"></th>
              </tr>
            </thead>
            <tbody><!-- se llena por JS --></tbody>
          </table>
        </section>
      </section>

      <!-- SECCI√ìN: SOPORTE (tipo estudiante) -->
      <section id="soporte" class="section">
        <div class="support-card">
          <div class="support-header">
            <h2>Soporte y ayuda para revisores</h2>
            <p>
              Si tienes dudas sobre el proceso de revisi√≥n, estados de ficha o problemas
              con la plataforma, utiliza estos canales de contacto oficiales.
            </p>
            <div class="chip-row">
              <span class="chip">Enfermer√≠a ¬∑ UNAB</span>
              <span class="chip">Campos cl√≠nicos</span>
              <span class="chip">Soporte revisor</span>
            </div>
          </div>

          <div class="support-grid">
            <article class="support-pill">
              <h3>Correo coordinaci√≥n</h3>
              <p>campo.clinico@uandresbello.edu</p>
            </article>
            <article class="support-pill">
              <h3>Horario de atenci√≥n</h3>
              <p>Lunes a viernes, 09:00‚Äì17:00 hrs.</p>
            </article>
            <article class="support-pill">
              <h3>Canal oficial</h3>
              <p>Anuncios en Canvas y correo institucional.</p>
            </article>
          </div>
        </div>
      </section>

      <!-- Modal (se mantiene para observaciones/rechazo) -->
      <div class="modal" id="mRechazo">
        <div class="box">
          <h3>Motivo de observaci√≥n / rechazo</h3>
          <textarea id="txtMotivo" placeholder="Escribe el detalle para el estudiante‚Ä¶"></textarea>
          <div class="actions">
            <button class="btn" id="btnCancelar">Cancelar</button>
            <button class="btn primary" id="btnGuardar">Guardar</button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<script type="application/javascript">
  // ========= DATA desde Django =========
  const DATA = [
  {% for f in fichas %}
  {
    id:  {{ f.id }},
    nombre: "{{ f.user.get_full_name|default:f.user.email|escapejs }}",
    rut: "{{ f.user.id|escapejs }}",
    email: "{{ f.user.email|escapejs }}",
    estado: "{{ f.get_estado_global_display|escapejs }}",
    estado_raw: "{{ f.estado_global|escapejs }}",
    fecha: "{{ f.updated_at|date:'Y-m-d H:i'|escapejs }}"
  }{% if not forloop.last %},{% endif %}
  {% empty %}{% endfor %}
];

  const URL_PDF_BASE         = "{% url 'ficha_pdf' %}".replace('/ficha/pdf/', '/ficha/pdf/?ficha_id=0');
  const URL_FIELD_API_BASE   = "{% url 'api_review_field' 0 %}";
  const URL_FINALIZE_API_BASE= "{% url 'api_review_finalize' 0 %}";
  const URL_DETALLE_BASE     = "{% url 'revisor_ficha' 0 %}";

  function getCookie(name){
    const v = ("; "+document.cookie).split("; "+name+"=");
    if(v.length===2) return v.pop().split(";").shift();
  }

  async function post(url, data){
    const form = new URLSearchParams();
    for(const k in data){ form.append(k, data[k]); }
    const r = await fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With":"XMLHttpRequest"
      },
      body: form
    });
    return await r.json();
  }

  function badgeClass(raw){
    if(raw === 'APROBADA') return 's-ok';
    if(raw === 'RECHAZADA') return 's-bad';
    return 's-warn';
  }

  const tbody       = document.querySelector('#tbl tbody');
  const q           = document.getElementById('q');
  const tabs        = Array.from(document.querySelectorAll('.tab'));
  const mRechazo    = document.getElementById('mRechazo');
  const txtMotivo   = document.getElementById('txtMotivo');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnGuardar  = document.getElementById('btnGuardar');
  const txtGlobalNotes = document.getElementById('globalNotes'); // NUEVO

  let filtro    = 'abiertas';
  let currentId = null;

  function isCerrada(raw){
    return raw === 'APROBADA' || raw === 'RECHAZADA';
  }

  function paint(){
    const term = (q.value || '').toLowerCase().trim();

    const rows = DATA
      .filter(function(x){
        const byTab =
          (filtro === 'todas') ||
          (filtro === 'cerradas' && isCerrada(x.estado_raw)) ||
          (filtro === 'abiertas' && !isCerrada(x.estado_raw));
        const byText = !term ||
          String(x.nombre||'').toLowerCase().includes(term) ||
          String(x.email||'').toLowerCase().includes(term);
        return byTab && byText;
      })
      .map(function(x){
        const tr = document.createElement('tr');
        const detalleHref = URL_DETALLE_BASE.replace('/0/', `/${x.id}/`);
        const pdfHref     = URL_PDF_BASE.replace('ficha_id=0', `ficha_id=${x.id}`);

        tr.innerHTML =
          '<td>' + (x.nombre || '-') + '</td>' +
          '<td>' + (x.rut || '-') + '</td>' +
          '<td>' + (x.email || '-') + '</td>' +
          '<td><span class="status ' + badgeClass(x.estado_raw) + '">' + x.estado + '</span></td>' +
          '<td>' + (x.fecha || '-') + '</td>' +
          '<td>' +
          `<a class="btn" href="${pdfHref}" target="_blank">Ficha</a> ` +
          `<a class="btn primary" href="${detalleHref}">Revisar</a> ` +
          `<button class="btn js-finalizar" data-id="${x.id}">Finalizar revisi√≥n</button>` +
          '</td>';
        return tr;
      });

    tbody.replaceChildren.apply(tbody, rows);

    // Bot√≥n "Finalizar revisi√≥n"
    tbody.querySelectorAll('.js-finalizar').forEach(btn=>{
      btn.onclick = async (e)=>{
        const id = Number(e.currentTarget.dataset.id);
        const urlFinalize = URL_FINALIZE_API_BASE.replace('/0/', `/${id}/`);

        // NUEVO: tomar el comentario general desde el textarea
        const globalNotes = (txtGlobalNotes && txtGlobalNotes.value)
          ? txtGlobalNotes.value
          : '';

        const res = await post(urlFinalize, { global_notes: globalNotes });
        if(res.ok){
          const it = DATA.find(z=>z.id===id);
          if(it){
            it.estado_raw = res.estado;
            it.estado = (res.estado === 'APROBADA') ? 'Aprobada' :
                        (res.estado === 'RECHAZADA') ? 'Rechazada' : it.estado;
          }
          // si quieres limpiar el comentario al terminar una ficha, descomenta:
          // txtGlobalNotes.value = '';
          paint();
        }else{
          alert('No se pudo finalizar: ' + (res.error||'error'));
        }
      };
    });

    // Handlers del modal (por si se usa desde otra parte)
    btnCancelar.onclick = function(){
      mRechazo.classList.remove('open');
    };

    btnGuardar.onclick = async function(){
      if(!currentId) return;
      const notes = (txtMotivo.value || '').trim();
      try{
        const urlField = URL_FIELD_API_BASE.replace('/0/', `/${currentId}/`);
        const r1 = await post(urlField, {
          field_key: "_global",
          section: "Global",
          status: "REVISADO_NO_OK",
          notes
        });
        if(!r1.ok){ throw new Error('Fallo al registrar observaci√≥n'); }

        const urlFinalize = URL_FINALIZE_API_BASE.replace('/0/', `/${currentId}/`);
        const r2 = await post(urlFinalize, {});
        if(!r2.ok){ throw new Error('Fallo al finalizar revisi√≥n'); }

        const it = DATA.find(z=>z.id===currentId);
        if(it){
          it.estado_raw = r2.estado;
          it.estado = (r2.estado === 'RECHAZADA') ? 'Rechazada' : it.estado;
        }
        paint();
        mRechazo.classList.remove('open');
      }catch(err){
        alert(err.message || 'Error inesperado');
      }
    };
  }

  // Filtros + b√∫squeda
  q.addEventListener('input', paint);
  tabs.forEach(function(t){
    t.addEventListener('click', function(){
      tabs.forEach(function(x){ x.classList.remove('active'); });
      t.classList.add('active');
      filtro = t.getAttribute('data-filter');
      paint();
    });
  });

  // Exponer el modal de motivo (para otros botones si quieres)
  window.openMotivo = function(id){
    currentId = id;
    txtMotivo.value = '';
    mRechazo.classList.add('open');
  };

  // Navegaci√≥n entre secciones (Revisi√≥n / Soporte)
  (function(){
    const navLinks = document.querySelectorAll('.nav-link[data-target]');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach(link=>{
      link.addEventListener('click', function(e){
        e.preventDefault();
        const target = this.dataset.target;
        sections.forEach(sec=>{
          sec.classList.toggle('active', sec.id === target);
        });
        navLinks.forEach(l=>l.classList.remove('active'));
        this.classList.add('active');
      });
    });
  })();

  paint();
</script>
</body>
</html>
