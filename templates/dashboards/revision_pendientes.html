<!DOCTYPE html>
<html lang="es" style="height: 100%;">
<head>
  <meta charset="utf-8"/>
  <title>Panel de Revisor – Campo Clínico UNAB</title>
  <style>
    /* ====== Shell tomado del estudiante (mismo layout/aside) ====== */
    body{min-height:100vh;margin:0;font-family:Arial, sans-serif;display:flex}
    aside{
      width:260px;background:#0b3a7e;color:#fff;border-right:1px solid #0a2f65;
      display:flex;flex-direction:column;padding:18px 16px
    }
    .brand{font-weight:800;letter-spacing:.4px;margin-bottom:8px}
    .user-card{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.08);
      padding:12px;border-radius:14px;margin:12px 0 16px}
    .avatar{width:36px;height:36px;border-radius:10px;background:#19437c;display:grid;place-items:center;font-weight:700}
    .small{font-size:12px;opacity:.8;margin-top:2px}
    nav .nav-link{display:block;padding:10px 12px;border-radius:10px;color:#fff;text-decoration:none;
      opacity:.95;border:1px solid transparent}
    nav .nav-link:hover{background:rgba(255,255,255,.12)}
    nav .active{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.25)}
    /* ====== Contenido principal ====== */
    main{flex:1;background:#f6f8fb;min-height:100vh}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 14px;font-size:22px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{border:1px solid #e6eaf0;background:#e9eef8;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:#2563eb;border-color:#2563eb;color:#fff}
    .search{flex:1;min-width:260px;padding:10px;border:1px solid #e6eaf0;border-radius:10px;background:#fff}
    .card{background:#fff;border:1px solid #e6eaf0;border-radius:12px;padding:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e6eaf0;padding:10px 12px;text-align:left;font-size:14px;vertical-align:top}
    .table th{background:#fafbfe}
    .status{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e6eaf0;background:#fff}
    .s-warn{background:#fff7ed;border-color:#fed7aa;color:#b45309}
    .s-ok{background:#ecfdf5;border-color:#bbf7d0;color:#059669}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e6eaf0;background:#fff;text-decoration:none;color:#111}
    .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
    /* Modal mínimo */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal .box{width:520px;max-width:92vw;background:#fff;border-radius:12px;padding:16px;border:1px solid #e6eaf0}
    .box h3{margin:0 0 10px}
    .box textarea{width:100%;min-height:120px;padding:10px;border:1px solid #e6eaf0;border-radius:10px}
    .box .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>

  <!-- ASIDE: igual al del estudiante, mostrando rol real -->
  <aside>
    <div class="brand">CAMPO CLÍNICO</div>
    <div class="user-card">
      <div class="avatar">US</div>
      <div>
        <div style="font-weight:700">{{ request.user.email }}</div>
        <div class="small">{{ request.user.get_rol_display|default:request.user.rol }}</div>
      </div>
    </div>

    <div style="font-size:12px;opacity:.8;margin:8px 0">NAVEGACIÓN</div>
    <nav>
      <a class="nav-link active" href="{% url 'revisiones_pendientes' %}">Revisión de fichas</a>
      <a class="nav-link" href="/soporte">Soporte</a>
      <!-- (Opcional) volver al dashboard estudiante si el revisor también estudia -->
      <!-- <a class="nav-link" href="{% url 'dashboard_estudiante' %}">Panel estudiante</a> -->
    </nav>
  </aside>

  <!-- CONTENIDO -->
  <main>
    <div class="wrap">
      <h1>Revisión de fichas</h1>

      <div class="row">
        <div class="tabs">
          <button class="tab active" data-filter="abiertas">Abiertas</button>
          <button class="tab" data-filter="cerradas">Cerradas</button>
          <button class="tab" data-filter="todas">Todas</button>
        </div>
        <input class="search" id="q" placeholder="Buscar por nombre o correo…"/>
      </div>

      <div class="card">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>RUT / ID</th>
              <th>Correo</th>
              <th>Estado</th>
              <th>Actualizada</th>
              <th></th>
            </tr>
          </thead>
          <tbody><!-- se llena por JS --></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal motivo de rechazo -->
  <div class="modal" id="mRechazo">
    <div class="box">
      <h3>Motivo de observación / rechazo</h3>
      <textarea id="txtMotivo" placeholder="Escribe el detalle para el estudiante…"></textarea>
      <div class="actions">
        <button class="btn" id="btnCancelar">Cancelar</button>
        <button class="btn primary" id="btnGuardar">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== DATA desde Django (mínimo: id, nombre, rut/id, email, estado, fecha_iso) ======
    const DATA = [
      {% for f in fichas %}
      {
        id: {{ f.id }},
        nombre: "{{ f.user.email|default:'-' }}",
        rut: "{{ f.user.id|default:'-' }}",
        email: "{{ f.user.email|default:'-' }}",
        estado: "{{ f.get_estado_global_display|default:f.estado_global }}",
        estado_raw: "{{ f.estado_global }}",
        fecha: "{{ f.updated_at|date:'Y-m-d H:i' }}"
      }{% if not forloop.last %},{% endif %}
      {% empty %}
      {% endfor %}
    ];

    // ====== UI ======
    const tbody = document.querySelector('#tbl tbody');
    const q = document.getElementById('q');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const mRechazo = document.getElementById('mRechazo');
    const txtMotivo = document.getElementById('txtMotivo');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnGuardar = document.getElementById('btnGuardar');

    let filtro = 'abiertas';
    let currentId = null;

    function paint(){
      const term = (q.value||'').toLowerCase().trim();
      const rows = DATA.filter(x=>{
        const byTab = (filtro==='todas') ||
                      (filtro==='cerradas' && (x.estado_raw==='APROBADA' || x.estado_raw==='CERRADA')) ||
                      (filtro==='abiertas' && !(x.estado_raw==='APROBADA' || x.estado_raw==='CERRADA'));
        const byText = !term || (x.nombre?.toLowerCase().includes(term) || x.email?.toLowerCase().includes(term));
        return byTab && byText;
      }).map(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.nombre||'-'}</td>
          <td>${x.rut||'-'}</td>
          <td>${x.email||'-'}</td>
          <td><span class="status ${x.estado_raw==='APROBADA'?'s-ok':'s-warn'}">${x.estado}</span></td>
          <td>${x.fecha||'-'}</td>
          <td>
            <a class="btn" href="/accounts/revisar/ficha/${x.id}/aprobar/">Aprobar</a>
            <button class="btn" onclick="openMotivo(${x.id})">Observar</button>
          </td>`;
        return tr;
      });
      tbody.replaceChildren(...rows);
    }

    q.addEventListener('input', paint);
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        filtro = t.dataset.filter;
        paint();
      });
    });

    btnCancelar.onclick = ()=> mRechazo.classList.remove('open');
    btnGuardar.onclick = ()=>{
      // aquí puedes hacer fetch POST a tu endpoint de observación si ya existe
      // fetch(`/accounts/revisar/ficha/${currentId}/observar/`, {method:'POST', body:...})
      mRechazo.classList.remove('open');
    };

    window.openMotivo = function(id){
      currentId = id;
      txtMotivo.value = "";
      mRechazo.classList.add('open');
    };

    paint();
  </script>
</body>
</html>
