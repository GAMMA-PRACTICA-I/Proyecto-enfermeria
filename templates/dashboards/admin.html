{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administrador – Soporte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg-page:#f3f4f6;
      --card-bg:#ffffff;
      --card-border:#e5e7eb;
      --text-main:#111827;
      --text-muted:#6b7280;
      --accent:#0b3a7e;
      --badge-new-bg:#eff6ff;
      --badge-new-border:#bfdbfe;
      --badge-new-text:#1d4ed8;
      --badge-closed-bg:#ecfdf5;
      --badge-closed-border:#bbf7d0;
      --badge-closed-text:#047857;
    }

    *{ box-sizing:border-box; }

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px 12px;
    }

    .dashboard-container{
      width:100%;
      max-width:1100px;
      background:var(--card-bg);
      border-radius:18px;
      border:1px solid var(--card-border);
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:18px 20px 22px;
    }

    .header-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    h1{
      margin:0 0 4px;
      font-size:1.3rem;
      color:var(--accent);
    }

    .subtitle{
      margin:0;
      font-size:0.9rem;
      color:var(--text-muted);
    }

    .logout-btn{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #111827;
      background:#0f172a;
      color:#f9fafb;
      cursor:pointer;
      font-size:0.8rem;
      font-family:inherit;
      white-space:nowrap;
      transition:background .15s ease, box-shadow .15s ease, transform .08s ease;
    }

    .logout-btn:hover{
      background:#111827;
      box-shadow:0 10px 20px rgba(15,23,42,.45);
      transform:translateY(-1px);
    }

    .filter-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:10px 0;
    }

    .filter-row input{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:0.82rem;
      min-width:220px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }

    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 10px;
      vertical-align:top;
      text-align:left;
    }

    th{
      background:#f9fafb;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:0.72rem;
      color:var(--text-muted);
      white-space:nowrap;
    }

    tbody tr:nth-child(even){
      background:#fbfbff;
    }

    .ticket-meta{
      font-size:0.75rem;
      color:var(--text-muted);
    }

    .badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:0.72rem;
      border:1px solid var(--badge-new-border);
      background:var(--badge-new-bg);
      color:var(--badge-new-text);
      white-space:nowrap;
    }

    .badge-closed{
      background:var(--badge-closed-bg);
      border-color:var(--badge-closed-border);
      color:var(--badge-closed-text);
    }

    .detalle{
      white-space:pre-wrap; /* respeta saltos de línea */
      max-width:420px;
    }

    .empty{
      text-align:center;
      padding:18px 10px;
      color:var(--text-muted);
      font-size:0.88rem;
    }

    @media (max-width: 768px){
      .dashboard-container{
        padding:14px 12px 18px;
      }
      th,td{
        padding:6px 6px;
      }
      .header-row{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="dashboard-container">

    <div class="header-row">
      <div>
        <h1>Panel de Administrador – Soporte</h1>
        <p class="subtitle">
          Aquí se muestran los mensajes de soporte enviados por los estudiantes desde la ficha.
        </p>
      </div>
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="logout-btn">Cerrar sesión</button>
      </form>
    </div>

    <div class="filter-row">
      <input id="filtro" type="text" placeholder="Filtrar por nombre, correo o asunto…">
    </div>

    {% if tickets %}
      <table id="tblTickets">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Estudiante</th>
            <th>Tipo / Asunto</th>
            <th>Detalle</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
        {% for t in tickets %}
          <tr>
            <td>
              {{ t.created_at|date:"Y-m-d H:i" }}
            </td>
            <td>
              {{ t.user.get_full_name|default:t.user.email }}<br>
              <span class="ticket-meta">{{ t.user.email }}</span>
            </td>
            <td>
              <strong>{{ t.tipo_consulta }}</strong><br>
              <span class="ticket-meta">{{ t.asunto }}</span>
            </td>
            <td class="detalle">
              {{ t.detalle }}
            </td>
            <td>
              {% if t.estado == "CERRADA" %}
                <span class="badge badge-closed">Cerrada</span>
              {% elif t.estado == "EN_PROCESO" %}
                <span class="badge">En proceso</span>
              {% else %}
                <span class="badge">Nueva</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty">
        Todavía no hay mensajes de soporte registrados.
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Filtro básico en el front: busca en toda la fila
  const inputFiltro = document.getElementById('filtro');
  const tabla = document.getElementById('tblTickets');

  if (inputFiltro && tabla) {
    inputFiltro.addEventListener('input', function () {
      const term = this.value.toLowerCase().trim();
      const filas = tabla.querySelectorAll('tbody tr');

      filas.forEach(function (tr) {
        const texto = tr.innerText.toLowerCase();
        tr.style.display = texto.includes(term) ? '' : 'none';
      });
    });
  }
</script>
</body>
</html>
