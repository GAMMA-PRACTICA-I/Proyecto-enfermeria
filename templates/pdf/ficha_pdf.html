<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Ficha Estudiantil</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: DejaVu Sans, Arial, Helvetica, sans-serif; font-size: 12px; color: #111; position: relative; }
    h1, h2 { margin: 0 0 8px; }
    h1 { font-size: 20px; }
    h2 { font-size: 16px; margin-top: 18px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    .muted { color: #555; }

    table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: top; }
    
    /* Estilo de tablas .kv (Key-Value) */
    .kv {
        border-top: 1px solid #ccc; 
        margin-top: 4px;
        margin-bottom: 12px;
    }
    .kv td { 
      border: none; 
      padding: 5px 0; 
      border-bottom: 1px solid #f0f0f0; 
    }

    /* ESTILOS DE CABECERA */
    .header-grid { 
        width:100%; 
        border-collapse:collapse; 
        border:none; 
        table-layout:fixed; 
        margin-top: 8px; 
    }
    .header-grid td { border:none; vertical-align:top; padding:0; }
    .header-meta p { 
        margin:0 0 2px 0; 
        line-height:1.2; 
        color:#555; 
        font-size:12pt; 
    }
    
    .foto-wrap { 
        text-align: right; 
    }
    /* FOTO DE PERFIL (120PX) */
    .foto-ficha {
      width: 120px;       
      height: auto;       
      display: inline-block;
      border: 1px solid #ddd;
      padding: 3px;
      background: #fff;
    }

    /* === NUEVO ESTILO: CAJA LIMITADORA INDIVIDUAL (180PX) === */
    .anexo-single-box {
      width: 186px; /* 180px para la imagen + borde/padding */
      display: inline-block;
      text-align: center;
      margin-right: 15px; /* Separación entre cajas */
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    .anexo-single-box .anexo-titulo-solo {
        font-size: 14px;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .anexo-single-box img {
        max-width: 180px;
        width: 180px; /* Tamaño forzado */
        height: auto;
        display: block;
        border: 1px solid #ddd;
        padding: 3px;
        background: #fff;
        margin: 0 auto;
    }
    /* ======================================================== */


    /* === ESTILOS PARA DOCUMENTACIÓN ADJUNTA (TABLA ESTRICTA, EL RESTO) === */
    .anexos-table {
        width: 100%;
        border-collapse: collapse;
        border: none;
        table-layout: fixed;
    }
    .anexos-table td {
        border: none;
        padding: 5px;
        vertical-align: top;
        width: 25%; /* Celdas para 4 imágenes por fila */
    }

    .anexo-titulo {
        margin-bottom: 5px;
        font-weight: bold;
        display: block;
        text-align: center;
    }

    /* IMAGEN DE ANEXO PARA LA TABLA (180PX) */
    .anexo-imagen {
      max-width: 180px; 
      width: 100%; 
      height: auto;       
      display: block;
      border: 1px solid #ddd;
      padding: 3px;
      background: #fff;
      margin: 0 auto; 
      page-break-inside: avoid; 
    }
  </style>
</head>
<body>

  <h1 style="text-align: center; margin-bottom: 0;">FICHA ESTUDIANTE PREGRADO</h1>
  <h3 style="text-align: center; color: #555; margin-top: 4px; margin-bottom: 15px; font-weight: normal;">CAMPOS CLÍNICOS</h3>

  <table class="header-grid">
    <tr>
      <td class="header-meta">
        <p><b>ID Ficha:</b> {{ ficha.id }}</p>
        <p><b>Email:</b> {{ data.user_email }}</p>
        <p><b>Estado:</b> {{ ficha.get_estado_global_display }}</p>
      </td>
      
      <td style="width: 130px; text-align:right; vertical-align:top;">
        {% if data.generales %}
          {% if data.generales.foto_ficha_path %}
            <div class="foto-wrap">
              <img class="foto-ficha" src="{{ data.generales.foto_ficha_path }}" alt="Foto ficha"/>
            </div>
          {% elif data.generales.foto_ficha_url %}
            <div class="foto-wrap">
              <img class="foto-ficha" src="{{ data.generales.foto_ficha_url }}" alt="Foto ficha"/>
            </div>
          {% elif data.generales.foto_ficha_b64 %}
            <div class="foto-wrap">
              <img class="foto-ficha" src="data:image/png;base64,{{ data.generales.foto_ficha_b64 }}" alt="Foto ficha"/>
            </div>
          {% endif %}
        {% endif %}
      </td>
    </tr>
  </table>

  {% if data.generales %}
  <h2>I. Antecedentes Generales</h2>
  <table class="kv">
    <tr><td><b>Nombre completo legal:</b> {{ data.generales.nombre_legal|default:"—" }}</td></tr>
    <tr><td><b>RUT/ID:</b> {{ data.generales.rut|default:"—" }}</td></tr>
    <tr><td><b>Género:</b> {{ data.generales.genero|default:"—" }}</td></tr>
    <tr><td><b>Fecha nacimiento:</b> {{ data.generales.fecha_nacimiento|default:"—" }}</td></tr>
    <tr><td><b>Teléfono celular:</b> {{ data.generales.telefono_celular|default:"—" }}</td></tr>
    <tr><td><b>Dirección residencial actual/ Comuna:</b> {{ data.generales.direccion_actual|default:"—" }}</td></tr>
    <tr><td><b>Dirección residencial de origen/ Comuna:</b> {{ data.generales.direccion_origen|default:"—" }}</td></tr>
    <tr><td><b>Correo electrónico institucional:</b> {{ data.academicos.correo_institucional|default:"—" }}</td></tr>
    <tr><td><b>Contacto en caso de emergencia:</b> {{ data.generales.contacto_emergencia_nombre|default:"—" }}</td></tr>
    <tr><td><b>Nombre y parentesco contacto de emergencia:</b> {{ data.generales.contacto_emergencia_nombre|default:"—" }} ({{ data.generales.contacto_emergencia_parentesco|default:"—" }})</td></tr>
    <tr><td><b>Teléfono contacto de emergencia:</b> {{ data.generales.contacto_emergencia_telefono|default:"—" }}</td></tr>
    <tr><td><b>Centro de salud:</b> {{ data.generales.centro_salud|default:"—" }}</td></tr>
    <tr><td><b>Previsión/Seguro:</b> {{ data.generales.seguro|default:"—" }} {{ data.generales.seguro_detalle|default:"" }}</td></tr>
  </table>
  {% endif %}

  {% if data.academicos %}
  <h2>II. Antecedentes Académicos</h2>
  <table class="kv">
    <tr><td><b>Nombre social:</b> {{ data.academicos.nombre_social|default:"—" }}</td></tr>
    <tr><td><b>Carrera:</b> {{ data.academicos.carrera|default:"—" }}</td></tr>
    <tr><td><b>Año que cursa:</b> {{ data.academicos.anio_cursa|default:"—" }}</td></tr>
    <tr><td><b>Estado (Curricular / Interno):</b> {{ data.academicos.estado|default:"—" }}</td></tr>
    <tr><td><b>Asignatura:</b> {{ data.academicos.asignatura|default:"—" }}</td></tr>
    <tr><td><b>Correo electrónico institucional:</b> {{ data.academicos.correo_institucional|default:"—" }}</td></tr>
    <tr><td><b>Correo electrónico personal:</b> {{ data.academicos.correo_personal|default:"—" }}</td></tr>
  </table>
  {% endif %}

  {% if data.medicos %}
  <h2>III. Antecedentes Mórbidos</h2>
  <table class="kv">
    <tr><td><b>Alergias:</b> {{ data.medicos.alergias_detalle|default:"—" }}</td></tr>
    <tr><td><b>Grupo sanguíneo:</b> {{ data.medicos.grupo_sanguineo|default:"—" }}</td></tr>
    <tr><td><b>Enfermedades crónicas o a declarar:</b> {{ data.medicos.cronicas_detalle|default:"—" }}</td></tr>
    <tr><td><b>Toma algún medicamento diario:</b> {{ data.medicos.medicamentos_detalle|default:"—" }}</td></tr>
    <tr><td><b>Otros antecedentes relevantes:</b> {{ data.medicos.otros_antecedentes|default:"—" }}</td></tr>
  </table>
  {% endif %}

  {% if data.vaccines or data.serologies %}
  <h2>IV. Vacunas / Serología</h2>
  <table>
    <thead><tr><th>Vacuna / Patrógeno</th><th>Serología / Dosis</th><th>Fecha</th></tr></thead>
    <tbody>
      {% for v in data.vaccines %}
      <tr>
        <td>{{ v.vaccine_type }}</td>
        <td>{{ v.dose_label }}</td>
        <td>{{ v.date }}</td>
      </tr>
      {% endfor %}
      {% for s in data.serologies %}
      <tr>
        <td>{{ s.pathogen }}</td>
        <td>{{ s.result }}</td>
        <td>{{ s.date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if data.declaracion %}
  <h2>V. Declaración</h2>
  <p class="muted">Declaro que la información entregada en esta ficha es verdadera, completa y exacta.</p>
  <table class="kv">
    <tr><td><b>Nombre estudiante:</b> {{ data.declaracion.nombre_estudiante|default:"—" }}</td></tr>
    <tr><td><b>RUT:</b> {{ data.declaracion.rut|default:"—" }}</td></tr>
    <tr><td><b>Fecha:</b> {{ data.declaracion.fecha|default:"—" }}</td></tr>
    <tr><td><b>Firma (texto):</b> {{ data.declaracion.firma|default:"—" }}</td></tr>
  </table>
  {% endif %}

{% if data.ci_frente_anexo or data.anexos %}
  <h2>VI. Documentación Adjunta</h2>
  <p class="muted">Imágenes y documentos adjuntos.</p>
  
  <div style="margin-top: 10px;">
    {# ESTRUCTURA SOLICITADA: CAJA LIMITADORA PARA IMAGEN ESPECÍFICA (CI_FRENTE) #}
    {% if data.ci_frente_anexo %}
      <div class="anexo-single-box">
          <p class="anexo-titulo-solo">GENERALES — CI_FRENTE</p>
          <img src="data:{{ data.ci_frente_anexo.mime|default:'image/png' }};base64,{{ data.ci_frente_anexo.b64 }}" 
               alt="CI Frente"/>
      </div>
    {% endif %}

    {# RESTO DE ANEXOS EN FORMATO DE TABLA (4 por fila) #}
    {% if data.anexos %}
      <table class="anexos-table">
        <tr>
        {% for anexo in data.anexos %}
          {# Excluir el CI_FRENTE si está en data.anexos y ya se mostró arriba. Usamos IF NOT para saltar el elemento. #}
          {% if not anexo.is_ci_frente %}
          
          <td style="width: 25%;">
            <div style="page-break-inside: avoid; text-align: center;">
              {% if anexo.titulo %}
                <p class="anexo-titulo">{{ anexo.titulo }}</p>
              {% endif %}

              {% if anexo.b64 %}
                <img class="anexo-imagen" 
                     src="data:{{ anexo.mime|default:'image/png' }};base64,{{ anexo.b64 }}" 
                     alt="Anexo"
                     style="max-width: 180px; width: 180px; height: auto;"/>
              {% endif %}
            </div>
          </td>
          
          {# Salto de fila: si es el cuarto elemento, pero no el último #}
          {# Nota: Esta lógica de salto de fila es imperfecta porque loop.index ahora cuenta los elementos que fueron omitidos, pero es la forma más limpia de evitar el error de sintaxis. #}
          {% if loop.index|divisibleby:4 and not loop.last %}
            </tr><tr>
          {% endif %}

          {% endif %} {# Cierre del if not anexo.is_ci_frente #}
        {% endfor %}
        </tr>
      </table>
    {% endif %}
  </div>
  {% endif %}

  <p class="muted" style="margin-top: 20px;">
    — Fin de la ficha —
  </p>
</body>
</html>