{% load static %}{% load review_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Revisi√≥n de Ficha ‚Äì Campo Cl√≠nico UNAB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =========================================
       ESTILOS PRINCIPALES (De revision_pendientes.html)
       ========================================= */
    :root{
      --sidebar-bg-top:#022a66;
      --sidebar-bg-bottom:#011537;
      --sidebar-border:#001229;
      --sidebar-text:#e5efff;
      --sidebar-muted:#9fb4dd;
      --sidebar-active:#ffd000;

      --bg-page:#f4f7fc;
      --card-bg:#ffffff;
      --card-border:#dde3f0;
      --card-shadow:0 14px 32px rgba(15,23,42,.12);

      --text-main:#0f172a;
      --text-muted:#6b7280;
      --accent:#0b3a7e;

      /* Estados espec√≠ficos para revisi√≥n */
      --ok-bg: #ecfdf5; --ok-text: #047857; --ok-border: #a7f3d0;
      --bad-bg: #fef2f2; --bad-text: #b91c1c; --bad-border: #fecaca;
    }

    *{ box-sizing:border-box; }

    html, body{ margin:0; padding:0; height:100%; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
      display:flex;
    }

    .app-shell{ display:flex; width:100%; min-height:100vh; }

    /* =========== SIDEBAR (Estilo Original) =========== */
    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--sidebar-bg-top),var(--sidebar-bg-bottom));
      border-right:1px solid var(--sidebar-border);
      color:var(--sidebar-text);
      padding:18px 18px 20px;
      display:flex; flex-direction:column; flex-shrink:0;
    }
    .brand-title{ font-size:0.78rem; letter-spacing:0.18em; text-transform:uppercase; color:var(--sidebar-muted); margin-bottom:2px; }
    .brand-main{ font-weight:600; font-size:0.98rem; }
    
    .user-box{
      margin-top:14px; display:flex; align-items:center; gap:10px; padding:10px 12px;
      border-radius:12px; background:rgba(0,0,0,.16); border:1px solid rgba(15,23,42,.55);
    }
    .user-avatar{
      width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center;
      font-weight:900; background:#0e4aa6; color:#fff; flex-shrink:0; font-size:0.9rem;
    }
    .user-info{ min-width:0; }
    .user-info strong{ display:block; font-size:0.86rem; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .user-info small{ display:block; font-size:0.76rem; color:var(--sidebar-muted); }

    .nav-label{ margin:16px 4px 6px; font-size:0.72rem; letter-spacing:0.18em; text-transform:uppercase; color:var(--sidebar-muted); }
    .nav-list{ list-style:none; margin:0; padding:4px; }
    
    .nav-link{
      display:flex; align-items:center; gap:8px; color:var(--sidebar-text); text-decoration:none;
      padding:8px 10px; border-radius:10px; border:1px solid transparent; cursor:pointer; font-size:0.86rem;
      transition:background .15s ease, transform .08s ease;
    }
    .nav-link:hover{ background:rgba(15,23,42,.6); transform:translateY(-1px); }
    .nav-link.active{ background:var(--sidebar-active); border-color:rgba(255,255,255,.25); color:#111827; font-weight:600; }
    .nav-link span.icon{
      width:20px; height:20px; border-radius:999px; border:1px solid rgba(203,213,225,.6);
      display:flex; align-items:center; justify-content:center; font-size:0.78rem;
    }
    
    .sidebar-footer{ margin-top:auto; padding-top:10px; border-top:1px solid rgba(15,23,42,.7); }
    .logout-btn{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,.9);
      background:#0f172a; color:#f9fafb; cursor:pointer; font-size:0.85rem; transition:0.15s;
    }
    .logout-btn:hover{ background:#111827; box-shadow:0 12px 22px rgba(15,23,42,.6); }

    /* =========== MAIN (Contenido) =========== */
    .main-wrapper{ flex:1; padding:24px 26px 80px; min-height:100vh; overflow-y: auto; position:relative; }
    .main-content{ max-width:1180px; margin:0 auto; }

    .page-header{ margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
    .page-header h1{ margin:0 0 4px; font-size:1.4rem; color:var(--accent); font-weight:600; }
    .page-header p{ margin:0; font-size:0.9rem; color:var(--text-muted); }

    /* Tarjetas de Secci√≥n */
    .table-card{
      background:var(--card-bg); border-radius:18px; border:1px solid var(--card-border);
      padding:0; box-shadow:var(--card-shadow); margin-bottom:24px; overflow:hidden;
    }
    .card-header-title {
        padding: 14px 20px; background: #fafbfe; border-bottom: 1px solid #e6eaf0;
        font-weight: 700; color: var(--accent); font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em;
    }

    /* Tablas */
    table.table{ width:100%; border-collapse:collapse; font-size:0.85rem; }
    .table th, .table td{ border-bottom:1px solid #e6eaf0; padding:12px 16px; text-align:left; vertical-align:top; }
    .table th{ background:#f8fafc; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.06em; color:#6b7280; }
    .table tr:last-child td { border-bottom: none; }

    /* Columnas y Elementos Espec√≠ficos */
    .col-label { width: 25%; font-weight: 600; color: var(--text-main); }
    .col-value { width: 30%; color: var(--text-muted); word-break: break-word; }
    .col-file  { width: 15%; }
    .col-action { width: 30%; text-align: right; }

    /* Botones de Archivo */
    .btn-mini {
        display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px;
        border-radius: 8px; font-size: 0.78rem; font-weight: 600; text-decoration: none;
        cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
    }
    .btn-view { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
    .btn-view:hover { background: #dbeafe; }
    .btn-pdf { background: #fff1f2; color: #be123c; border-color: #fecdd3; }
    .btn-pdf:hover { background: #ffe4e6; }
    .no-file { color: #9ca3af; font-style: italic; font-size: 0.8rem; }

    /* CONTROLES DE REVISI√ìN */
    .review-controls { display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
    
    /* El input real se oculta completamente */
    .check-input { position: absolute; opacity: 0; pointer-events: none; }

    /* Estilo del Bot√≥n */
    .check-label {
        display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
        border: 1px solid #cbd5e1; border-radius: 6px; background: #fff;
        color: #64748b; font-size: 0.85rem; font-weight: 500; cursor: pointer;
        transition: all 0.2s; user-select: none;
    }
    .check-label:hover { background: #f1f5f9; color: #334155; }

    /* ESTADOS ACTIVOS (Cuando se selecciona) */
    .check-input[value="REVISADO_OK"]:checked + .check-label {
        background: #dcfce7; color: #166534; border-color: #86efac; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .check-input[value="REVISADO_NO_OK"]:checked + .check-label {
        background: #fee2e2; color: #991b1b; border-color: #fca5a5; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* TEXTO DE ESTADO (La Gu√≠a) */
    .status-text { 
        font-size: 0.8rem; font-weight: 700; margin-left: 12px; min-width: 80px; text-align: center;
        padding: 4px 8px; border-radius: 4px; background: #f1f5f9; color: #94a3b8;
    }
    .status-text.ok { background: #dcfce7; color: #15803d; } 
    .status-text.bad { background: #fee2e2; color: #b91c1c; }
    .radio-label:hover { background: #f9fafb; border-color: #d1d5db; }
    .radio-input { display: none; }

    /* Estados Activos */
    .radio-input[value="REVISADO_OK"]:checked + .radio-label {
        background: var(--ok-bg); color: var(--ok-text); border-color: var(--ok-border);
    }
    .radio-input[value="REVISADO_NO_OK"]:checked + .radio-label {
        background: var(--bad-bg); color: var(--bad-text); border-color: var(--bad-border);
    }

    /* Status Text indicator */
    .status-indicator { font-size: 0.75rem; font-weight: 700; min-width: 70px; text-align: center; }
    .status-indicator.ok { color: var(--ok-text); }
    .status-indicator.bad { color: var(--bad-text); }
    
    /* Textarea para observaciones */
    .notes-area {
        width: 100%; margin-top: 8px; padding: 8px; border-radius: 8px;
        border: 1px solid #d1d5db; font-family: inherit; font-size: 0.85rem;
        resize: vertical; min-height: 50px; display: none;
    }
    .notes-area:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

    /* Footer Flotante */
    .floating-footer {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-40%);
        background: #0f172a; color: #fff; padding: 12px 24px; border-radius: 99px;
        display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        z-index: 50; border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-finish {
        background: var(--sidebar-active); color: #0f172a; border: none; padding: 8px 20px;
        border-radius: 99px; font-weight: 700; cursor: pointer; font-size: 0.9rem;
        transition: transform 0.1s;
    }
    .btn-finish:hover { transform: scale(1.05); }

    /* Modal de Imagen */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000;
        display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px);
    }
    .modal-overlay.open { display: flex; }
    .modal-img-content { position: relative; max-width: 90%; max-height: 90%; }
    .modal-img-content img { max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
    .close-modal {
        position: absolute; top: -40px; right: 0; color: #fff; font-size: 2rem;
        font-weight: bold; cursor: pointer;
    }
    
    @media (max-width: 1024px) { .floating-footer { left: 20px; right: 20px; transform: none; justify-content: space-between; } }
    @media (max-width: 768px){
      .sidebar { display:none; } /* Ocultar sidebar en movil por ahora o ajustar */
      .main-wrapper { padding: 16px; }
    }
  </style>
</head>

<body>
<div class="app-shell">

  <aside class="sidebar">
    <div>
      <div class="brand-title">CAMPO CL√çNICO ¬∑ UNAB</div>
      <div class="brand-main">Panel de revisor</div>

      <div class="user-box">
        <div class="user-avatar">{{ request.user.first_name|default:"R"|first|upper }}</div>
        <div class="user-info">
          <strong title="{{ request.user.get_full_name }}">
            {{ request.user.get_full_name|default:request.user.email|truncatechars:20 }}
          </strong>
          <small>Revisor</small>
        </div>
      </div>

      <div class="nav-label">Navegaci√≥n</div>
      <ul class="nav-list">
        <li>
          <a href="{% url 'revisiones_pendientes' %}" class="nav-link">
            <span class="icon">‚Üê</span>
            <span>Volver a Lista</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link active">
            <span class="icon">üìã</span>
            <span>Ficha Actual</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
      </form>
    </div>
  </aside>

  <div class="main-wrapper">
    <main class="main-content">
      
      <div class="page-header">
        <div>
            <h1>Revisi√≥n: {{ ficha.user.email }}</h1>
            <p>
                Estado: <strong style="color:var(--accent)">{{ ficha.get_estado_global_display }}</strong> ‚Ä¢ 
                Actualizado: {{ ficha.updated_at|date:"d/m/Y H:i" }}
            </p>
        </div>
      </div>

      {% for section in render_data %}
      <section class="table-card">
        <div class="card-header-title">{{ section.title }}</div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th class="col-label">Item</th>
                <th class="col-value">Valor</th>
                <th class="col-file">Archivo</th>
                <th class="col-action">Evaluaci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for label, value, doc_obj, review_key, is_photo in section.rows %}
              {% with review=prev|get_item:review_key %}
              <tr>
                <td class="col-label">{{ label }}</td>
                <td class="col-value">{{ value|linebreaksbr }}</td>
                
                <td class="col-file">
                    {% if is_photo and tiene_foto %}
                        {% url 'serve_ficha_photo' ficha_id=ficha.id as url %}
                        <button type="button" class="btn-mini btn-view" onclick="verImagen('{{ url }}')">üì∑ Ver Foto</button>
                    {% elif doc_obj %}
                        {% url 'serve_document_file' doc_id=doc_obj.id as url %}
                        {% if '.pdf' in doc_obj.file_name|lower %}
                             <a href="{{ url }}" target="_blank" class="btn-mini btn-pdf">üìÑ PDF</a>
                        {% else %}
                             <button type="button" class="btn-mini btn-view" onclick="verImagen('{{ url }}')">üñºÔ∏è Imagen</button>
                        {% endif %}
                    {% endif %}
                </td>

                    <td class="col-action">
                        <div class="review-controls">
                            <label class="check-label">
                                <input type="radio" class="check-input" name="r_{{ review_key }}" value="REVISADO_OK" 
                                    {% if current_review.status == 'REVISADO_OK' %}checked{% endif %}
                                    onchange="markReview('{{ review_key }}', 'REVISADO_OK', '{{ section.title|escapejs }}', this)">
                                Aprobar
                            </label>
                            
                            <label class="check-label">
                                <input type="radio" class="check-input" name="r_{{ review_key }}" value="REVISADO_NO_OK" 
                                    {% if current_review.status == 'REVISADO_NO_OK' %}checked{% endif %}
                                    onchange="toggleNotes(this); markReview('{{ review_key }}', 'REVISADO_NO_OK', '{{ section.title|escapejs }}', this)">
                                Observar
                            </label>
                            
                            <span class="status-text {% if current_review.status == 'REVISADO_OK' %}ok{% elif current_review.status == 'REVISADO_NO_OK' %}bad{% endif %}">
                                {{ current_review.get_status_display|default:'Pendiente' }}
                            </span>
                        </div>

                        <div class="notes-box" style="display:{% if current_review.status == 'REVISADO_NO_OK' %}block{% else %}none{% endif %};">
                            <textarea placeholder="Indique el motivo..." onblur="markReview('{{ review_key }}', 'REVISADO_NO_OK', '{{ section.title|escapejs }}', this)">{% if current_review %}{{ current_review.notes }}{% endif %}</textarea>
                        </div>
                    </td>
              </tr>
              {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      {% endfor %}

    </main>

    <div class="floating-footer">
        <span style="opacity:0.8; font-size:0.9rem">Revisando a <strong>{{ ficha.user.get_full_name }}</strong></span>
        <button class="btn-finish" onclick="finalizeReview()">Finalizar Revisi√≥n</button>
    </div>

  </div>
</div>

<div id="visor" class="modal-overlay" onclick="cerrarVisor()">
    <div class="modal-img-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="cerrarVisor()">√ó</span>
        <img id="visorImg" src="">
    </div>
</div>

<script>
  function getCookie(name){ const v = `; ${document.cookie}`.split(`; ${name}=`); if(v.length===2) return v.pop().split(';').shift(); }
  const csrftoken = getCookie('csrftoken');

  // L√≥gica Visual (Modal)
  function verImagen(url){
      document.getElementById('visorImg').src = url;
      document.getElementById('visor').classList.add('open');
  }
  function cerrarVisor(){
      document.getElementById('visor').classList.remove('open');
      document.getElementById('visorImg').src = "";
  }

  // L√≥gica UI (Mostrar textarea)
  function toggleNotes(radio){
      const box = radio.closest('td').querySelector('.notes-box');
      box.style.display = radio.value === 'REVISADO_NO_OK' ? 'block' : 'none';
  }

  // L√≥gica Guardado + Actualizaci√≥n Visual
  async function guardar(key, status, section, el){
      const cell = el.closest('td');
      const txt = cell.querySelector('textarea');
      const notes = (status === 'REVISADO_NO_OK' && txt) ? txt.value : '';
      const statusSpan = cell.querySelector('.status-text'); // Referencia al texto de estado
      
      // 1. Actualizar Texto Visualmente (Lo que pediste)
      if(status === 'REVISADO_OK'){
         statusSpan.textContent = 'Aprobado';
         statusSpan.className = 'status-text ok';
      } else {
         statusSpan.textContent = 'Observado';
         statusSpan.className = 'status-text bad';
      }

      // 2. Mostrar/Ocultar textarea si es necesario
      if(txt) txt.parentElement.style.display = (status === 'REVISADO_NO_OK') ? 'block' : 'none';

      // 3. Enviar al servidor
      try {
          await fetch(`/accounts/api/review/field/{{ ficha.id }}/`, {
              method: 'POST',
              headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
              body: new URLSearchParams({ field_key: key, section: section, status: status, notes: notes })
          });
      } catch(e){ console.error(e); }
  }

  async function markReview(key, status, sectionTitle, el){
      const td = el.closest('td');
      const notes = (status === 'REVISADO_NO_OK') ? td.querySelector('textarea').value : '';
      
      // 1. Actualizar el texto de estado (La gu√≠a)
      const span = td.querySelector('.status-text');
      if(status === 'REVISADO_OK'){
          span.textContent = 'Aprobado';
          span.className = 'status-text ok';
      } else {
          span.textContent = 'Observado';
          span.className = 'status-text bad';
      }

      // 2. Enviar datos al servidor
      try {
          await fetch(`/accounts/api/review/field/{{ ficha.id }}/`, {
              method: 'POST',
              headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
              body: new URLSearchParams({ field_key: key, section: sectionTitle, status: status, notes: notes })
          });
      } catch(e){ console.error("Error guardando:", e); }
  }

  // L√≥gica Finalizar (Nombre corregido para coincidir con el bot√≥n)
  async function finalizeReview(){
      const g = prompt("Comentario global (opcional) para el estudiante:");
      if(g === null) return; // Cancelar
      
      try {
          const res = await fetch(`/accounts/api/review/finalize/{{ ficha.id }}/`, {
              method: 'POST',
              headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
              body: new URLSearchParams({ global_notes: g })
          });
          if(res.ok) window.location.href = "{% url 'revisiones_pendientes' %}";
          else alert("Error al finalizar.");
      } catch(e){ alert("Error de conexi√≥n"); }
  }
</script>
</body>
</html>