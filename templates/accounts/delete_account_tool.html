<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <title>Herramienta ‚Äì Eliminar Cuenta</title>
    <style>
        /* Estilos base */
        body { font-family: Arial, sans-serif; padding: 20px; background: #f9fafb; }
        .box { width: 400px; max-width: 95%; margin: 20px auto; background: #fff; border: 1px solid #e6eaf0; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { font-size: 22px; margin-top: 0; color: #dc3545; }
        p.muted { color: #555; font-size: 14px; }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 14px; }
        input[type="email"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 4px; border-color: #dc3545; }
        .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
        .btn { padding: 10px 15px; border-radius: 8px; border: 1px solid #e6eaf0; background: #fff; text-decoration: none; cursor: pointer; }
        .btn.danger { background: #dc3545; border-color: #dc3545; color: #fff; }
        .message-box { padding: 10px; margin-top: 15px; border-radius: 6px; }
        .success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        /* Estilos de visualizaci√≥n de detalles de usuario */
        .user-details { border: 1px solid #f5c2c7; padding: 10px; margin-top: 10px; border-radius: 6px; background-color: #f8d7da; }
        .user-details p { margin: 5px 0; font-size: 14px; }
        .user-details strong { color: #842029; }
    </style>
</head>
<body>

<div class="box">
    <h1>üóëÔ∏è Eliminar Cuenta de Usuario</h1>
    <p class="muted" style="color: #dc3545;">
        ‚ö†Ô∏è **ADVERTENCIA:** Esta acci√≥n es irreversible y eliminar√° el usuario y todos los datos asociados (fichas, documentos, comentarios).
    </p>

    <form id="frmDeleteUser">
        {% csrf_token %}
        <label for="delEmail">Correo del usuario a eliminar</label>
        <input type="email" id="delEmail" name="email" placeholder="ejemplo@unab.cl" required 
               data-logged-email="{{ request.user.email|default:'' }}">

        <div id="userDetails" class="user-details" style="display:none;">
            <p>Datos de la cuenta a **ELIMINAR**:</p>
            <p>Nombre: <strong id="userNameDisplay"></strong></p>
            <p>Rol: <strong id="userRolDisplay"></strong></p>
        </div>
        
        <div id="messageBox" class="message-box" style="display:none;"></div>

        <div class="actions">
            <a class="btn" href="{% url 'dashboard_admin_soporte' %}">Volver al Panel</a>
            <button type="submit" class="btn danger" id="btnDeleteUser" disabled>ELIMINAR PERMANENTEMENTE</button>
        </div>
    </form>
</div>

<script>
    // URLs de las APIs
    const URL_DELETE_API = "{% url 'api_delete_user' %}";
    const URL_FETCH_USER_API = "{% url 'api_fetch_user_details' %}"; // Usaremos esta para pre-validar
    
    // Elementos DOM
    const frmDeleteUser = document.getElementById('frmDeleteUser');
    const delEmail = document.getElementById('delEmail');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const messageBox = document.getElementById('messageBox');
    const userDetails = document.getElementById('userDetails');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userRolDisplay = document.getElementById('userRolDisplay');
    
    // Obtener el email del usuario logueado (pasado a trav√©s del atributo data)
    const loggedInUserEmail = delEmail.getAttribute('data-logged-email').toLowerCase();


    // --- Helpers de Mensajes y Cookies ---
    function showMessage(type, content) {
        messageBox.style.display = 'block';
        messageBox.className = 'message-box ' + type;
        messageBox.textContent = content;
    }

    function hideDetails() {
        userDetails.style.display = 'none';
        btnDeleteUser.disabled = true;
    }

    function getCookie(name) {
        const v = ("; " + document.cookie).split("; " + name + "=");
        if (v.length === 2) return v.pop().split(";").shift();
    }
    
    // Funci√≥n para retrasar la ejecuci√≥n (debounce)
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- Fetcher Gen√©rico ---
    async function post(url, data) {
        const form = new URLSearchParams();
        for (const k in data) { form.append(k, data[k]); }
        const r = await fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
            },
            body: form
        });
        
        let json_data;
        try {
            json_data = await r.json();
        } catch (e) {
            return { ok: false, error: "Error de servidor (respuesta no JSON)." };
        }
        
        return json_data;
    }

    // --- L√≥gica de Carga de Usuario (Pre-validaci√≥n) ---
    delEmail.addEventListener('input', debounce(async function() {
        messageBox.style.display = 'none';
        const email = (delEmail.value || '').trim().toLowerCase();
        hideDetails();

        if (email.length < 5 || email.indexOf('@') === -1) {
            return;
        }

        // Validaci√≥n 1: Evitar auto-eliminaci√≥n (Frontend)
        if (email === loggedInUserEmail) {
            showMessage('error', "‚ùå No puedes eliminar tu propia cuenta desde esta herramienta.");
            return;
        }

        showMessage('muted', `Buscando usuario ${email}...`);

        try {
            const res = await fetch(`${URL_FETCH_USER_API}?email=${encodeURIComponent(email)}`);
            const json_data = await res.json();

            messageBox.style.display = 'none'; // Limpiar mensaje de b√∫squeda

            if (json_data.ok) {
                // Validaci√≥n exitosa: Mostrar datos y habilitar
                const fullName = (json_data.first_name || '') + ' ' + (json_data.last_name || '');
                
                userNameDisplay.textContent = fullName.trim() || json_data.rut || json_data.email;
                userRolDisplay.textContent = json_data.rol;
                
                userDetails.style.display = 'block';
                btnDeleteUser.disabled = false;
                showMessage('error', `ATENCI√ìN: Cuenta de ${json_data.rol} cargada. Confirma que deseas ELIMINARla.`)
            } else {
                // Usuario no encontrado o error
                showMessage('error', `‚ùå Fallo: ${json_data.error}`);
            }
        } catch (err) {
            showMessage('error', "‚ö†Ô∏è Error de conexi√≥n/servidor al buscar usuario. Revisa la consola.");
            console.error(err);
        }
    }, 500));

    // --- L√≥gica de Eliminaci√≥n (Submit) ---
    frmDeleteUser.onsubmit = async function(e) {
        e.preventDefault();
        messageBox.style.display = 'none';

        const email = (delEmail.value || '').trim();

        if (btnDeleteUser.disabled) {
            showMessage('error', 'Busca y confirma la cuenta antes de eliminar.');
            return;
        }
        
        if (!confirm(`¬øEst√°s seguro de que deseas ELIMINAR permanentemente la cuenta de usuario con el email: ${email}? ESTA ACCI√ìN NO SE PUEDE DESHACER.`)) {
            return;
        }

        btnDeleteUser.disabled = true;
        btnDeleteUser.textContent = 'Eliminando...';

        try {
            const res = await post(URL_DELETE_API, { email: email });

            if (res.ok) {
                showMessage('success', `‚úÖ √âxito: ${res.message}`);
                delEmail.value = ''; // Limpiar campo tras √©xito
                hideDetails(); // Ocultar datos
            } else {
                showMessage('error', `‚ùå Fallo: ${res.error || 'Error desconocido.'}`);
            }
        } catch (err) {
            showMessage('error', "‚ö†Ô∏è Error de conexi√≥n/servidor. Revisa la consola.");
            console.error(err);
        } finally {
            btnDeleteUser.disabled = false;
            btnDeleteUser.textContent = 'ELIMINAR PERMANENTEMENTE';
        }
    };
</script>